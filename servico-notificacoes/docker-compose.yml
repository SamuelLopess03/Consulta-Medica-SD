version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - consulta-medica-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  notificacoes:
    build: .
    container_name: servico-notificacoes
    depends_on:
      rabbitmq:
        condition: service_healthy
    env_file:
      - .env
    environment:
      RABBITMQ_URL: amqp://admin:admin@rabbitmq:5672
      RABBITMQ_TOPIC: sd/notificacoes
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_SECURE: ${EMAIL_SECURE:-false}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASS: ${EMAIL_PASS}
      EMAIL_FROM: ${EMAIL_FROM:-Sistema de Consultas MÃ©dicas <noreply@consultamedica.com>}
      NODE_ENV: production
    networks:
      - consulta-medica-network
    restart: unless-stopped

volumes:
  rabbitmq_data:


networks:
  consulta-medica-network:
    driver: bridge
